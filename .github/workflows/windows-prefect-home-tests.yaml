name: Windows PREFECT_HOME Tests

# Test that PREFECT_HOME is properly respected on Windows
# and measure task creation performance differences between Windows and Linux
# Related to issue #19581

on:
  # Temporarily enabled for PR to inspect behavior
  pull_request:
    branches:
      - main
    paths:
      - ".github/workflows/windows-prefect-home-tests.yaml"
      - "scripts/test_prefect_home.py"
      - "src/prefect/settings/**"
  workflow_dispatch: {}

permissions: {}

jobs:
  test-prefect-home-windows:
    name: Test PREFECT_HOME on Windows
    runs-on: windows-latest
    timeout-minutes: 15

    permissions:
      contents: read

    strategy:
      matrix:
        prefect_home_type:
          - default
          - custom

    env:
      PY_COLORS: 1

    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Set up uv and Python
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          python-version: "3.12"
          cache-dependency-glob: "pyproject.toml"

      - name: Set custom PREFECT_HOME
        if: matrix.prefect_home_type == 'custom'
        shell: pwsh
        run: |
          $customHome = "$env:RUNNER_TEMP\prefect_home_test"
          New-Item -ItemType Directory -Path $customHome -Force
          echo "PREFECT_HOME=$customHome" >> $env:GITHUB_ENV
          echo "Using custom PREFECT_HOME: $customHome"

      - name: Display PREFECT_HOME configuration
        shell: pwsh
        run: |
          echo "PREFECT_HOME env: $env:PREFECT_HOME"
          echo "Home type: ${{ matrix.prefect_home_type }}"

      - name: Run PREFECT_HOME test
        id: test
        shell: pwsh
        run: |
          uv run python scripts/test_prefect_home.py

      - name: Verify PREFECT_HOME was respected
        if: matrix.prefect_home_type == 'custom'
        shell: pwsh
        run: |
          $customHome = "$env:RUNNER_TEMP\prefect_home_test"
          if (Test-Path "$customHome\prefect.db") {
            echo "SUCCESS: prefect.db was created in custom PREFECT_HOME"
          } else {
            echo "WARNING: prefect.db was NOT found in custom PREFECT_HOME"
            echo "Checking default location..."
            if (Test-Path "$env:USERPROFILE\.prefect\prefect.db") {
              echo "FAILURE: prefect.db was created in default location instead of custom PREFECT_HOME"
              exit 1
            }
          }
          # List contents of custom PREFECT_HOME
          echo "Contents of custom PREFECT_HOME:"
          Get-ChildItem -Path $customHome -Recurse -ErrorAction SilentlyContinue

  test-prefect-home-linux:
    name: Test PREFECT_HOME on Linux
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: read

    strategy:
      matrix:
        prefect_home_type:
          - default
          - custom

    env:
      PY_COLORS: 1

    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Set up uv and Python
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          python-version: "3.12"
          cache-dependency-glob: "pyproject.toml"

      - name: Set custom PREFECT_HOME
        if: matrix.prefect_home_type == 'custom'
        run: |
          custom_home="${RUNNER_TEMP}/prefect_home_test"
          mkdir -p "$custom_home"
          echo "PREFECT_HOME=$custom_home" >> $GITHUB_ENV
          echo "Using custom PREFECT_HOME: $custom_home"

      - name: Display PREFECT_HOME configuration
        run: |
          echo "PREFECT_HOME env: ${PREFECT_HOME:-not set}"
          echo "Home type: ${{ matrix.prefect_home_type }}"

      - name: Run PREFECT_HOME test
        id: test
        run: |
          uv run python scripts/test_prefect_home.py

      - name: Verify PREFECT_HOME was respected
        if: matrix.prefect_home_type == 'custom'
        run: |
          custom_home="${RUNNER_TEMP}/prefect_home_test"
          if [ -f "$custom_home/prefect.db" ]; then
            echo "SUCCESS: prefect.db was created in custom PREFECT_HOME"
          else
            echo "WARNING: prefect.db was NOT found in custom PREFECT_HOME"
            echo "Checking default location..."
            if [ -f "$HOME/.prefect/prefect.db" ]; then
              echo "FAILURE: prefect.db was created in default location instead of custom PREFECT_HOME"
              exit 1
            fi
          fi
          # List contents of custom PREFECT_HOME
          echo "Contents of custom PREFECT_HOME:"
          ls -la "$custom_home" || true

  compare-results:
    name: Compare Windows vs Linux Performance
    runs-on: ubuntu-latest
    needs: [test-prefect-home-windows, test-prefect-home-linux]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "## PREFECT_HOME Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow tests that PREFECT_HOME is properly respected on both Windows and Linux." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Matrix" >> $GITHUB_STEP_SUMMARY
          echo "- Windows: default and custom PREFECT_HOME" >> $GITHUB_STEP_SUMMARY
          echo "- Linux: default and custom PREFECT_HOME" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the individual job logs for detailed timing information." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Related to issue #19581" >> $GITHUB_STEP_SUMMARY
