---
title: How to run background tasks in a FastAPI app
sidebarTitle: Run background tasks in a FastAPI app
---

<Note>
**Prerequisites**

This guide requires FastAPI to be installed and an accessible Prefect server.

You can install FastAPI with `pip install fastapi` and run a local Prefect server with `prefect server start`.
</Note>

### Create a FastAPI app

For this guide, we'll create a simple FastAPI app with a single endpoint.

```python api.py
import uuid

import fastapi
import uvicorn
from pydantic import BaseModel, Field

users = {}


# Models representing request and response bodies
class User(BaseModel):
    id: uuid.UUID = Field(default_factory=uuid.uuid4)
    email: str
    name: str
    is_active: bool = Field(default=True)


class NewUser(BaseModel):
    email: str
    name: str

app = fastapi.FastAPI()


@app.post("/users", status_code=201)
async def create_user(new_user: NewUser) -> User:
    user = User(**new_user.model_dump())
    users[user.id] = user

    return user


if __name__ == "__main__":
    uvicorn.run("fastapi_task_worker:app", host="0.0.0.0", reload=True)
```

Let's say you want to send a welcome email to the user when they are created, but you don't want to delay the response to the client.

You can use Prefect to execute the email sending task in the background.

### Define a task and server alongside the app

Here's a simple task that pretends to send a welcome email to the user.

```python 
from prefect import task

@task
def send_welcome_email(user: User):
    print(f"Sending welcome email to {user.email}")
```

You can serve the task alongside the FastAPI by starting the task worker in the lifespan of the app.

```python api.py {27-41, 52}
import asyncio
import uuid
from contextlib import asynccontextmanager

import fastapi
import uvicorn
from pydantic import BaseModel, Field

from prefect import task

users = {}


# Models representing request and response bodies
class User(BaseModel):
    id: uuid.UUID = Field(default_factory=uuid.uuid4)
    email: str
    name: str
    is_active: bool = Field(default=True)


class NewUser(BaseModel):
    email: str
    name: str


@task
def send_welcome_email(user: User):
    print(f"Sending welcome email to {user.email}")


@asynccontextmanager
async def lifespan(app: fastapi.FastAPI):
    # start the task worker to serve the welcome email task
    asyncio_task = asyncio.create_task(send_welcome_email.serve())
    yield
    try:
        asyncio_task.cancel()
        await asyncio_task
    except Exception:
        pass


app = fastapi.FastAPI(lifespan=lifespan)


@app.post("/users", status_code=201)
async def create_user(new_user: NewUser) -> User:
    user = User(**new_user.model_dump())
    users[user.id] = user

    send_welcome_email.delay(user)

    return user


if __name__ == "__main__":
    uvicorn.run("fastapi_task_worker:app", host="0.0.0.0", reload=True)
```


### Run the FastAPI app and send a request

You can run the FastAPI app by execution the script.

```bash
python api.py
```

You can send a request to the app by using `curl` or a tool like [Postman](https://www.postman.com/).

```bash
curl -X POST http://localhost:8000/users \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "name": "Test User"}'
```

You can verify that the background task is executing by checking the console output of the FastAPI app.
