---
title: How to write a Prefect plugin 
sidebarTitle: Write a plugin
---

<Warning>
**Experimental Feature**

The plugin system is an **experimental feature** under active development. The API is subject to change without notice, and features may be modified or removed in future releases.
</Warning>

The Prefect plugin system allows third-party packages to run hooks when Prefect is imported. This enables plugins to configure environment variables, authenticate with external services, or perform other initialization tasks automatically - whether you're running CLI commands, Python scripts, workers, or agents.

## Use Cases

The plugin system is designed for scenarios where you need to:

- **Obtain short-lived credentials**: Automatically fetch temporary AWS credentials, service tokens, or API keys before workflow execution
- **Configure environment variables**: Set up environment-specific configuration based on the execution context
- **Initialize external services**: Connect to secret managers, credential stores, or authentication providers
- **Prepare execution environments**: Ensure required resources or configurations are available before workflows run

## Quick Start

### Enabling the Plugin System

The plugin system is opt-in and disabled by default. Enable it by setting the environment variable:

```bash
export PREFECT_EXPERIMENTAL_PLUGINS=1
```

Once enabled, plugins will automatically run whenever Prefect is imported - this includes:
- Python scripts that import Prefect (`import prefect`)
- CLI commands (`prefect deploy`, `prefect server start`, etc.)
- Workers and agents starting up
- Any process that uses Prefect

This ensures your environment is properly configured before any Prefect code executes.

### Example Plugin

Here's a minimal example plugin that sets environment variables:

```python
# my_plugin/__init__.py
from prefect._experimental.plugins import register_hook, HookContext, SetupResult

class Plugin:
    @register_hook
    def setup_environment(self, *, ctx: HookContext):
        """Configure environment before Prefect starts."""
        # Perform authentication or configuration
        credentials = fetch_credentials()

        return SetupResult(
            env={
                "MY_SERVICE_TOKEN": credentials.token,
                "MY_SERVICE_URL": "https://api.example.com",
            },
            note="Configured my-service credentials",
            expires_at=credentials.expires_at,
            required=True  # Abort if this plugin fails in strict mode
        )

def fetch_credentials():
    # Your authentication logic here
    pass
```

Register the plugin in your `pyproject.toml`:

```toml
[project.entry-points."prefect.plugins"]
my_plugin = "my_plugin:Plugin"
```

## Configuration

### Environment Variables

Configure the plugin system with these environment variables:

| Variable | Description | Default |
|----------|-------------|---------|
| `PREFECT_EXPERIMENTAL_PLUGINS` | Enable/disable the plugin system | `0` (disabled) |
| `PREFECT_PLUGINS_ALLOW` | Comma-separated list of allowed plugin names | None (all allowed) |
| `PREFECT_PLUGINS_DENY` | Comma-separated list of denied plugin names | None (none denied) |
| `PREFECT_PLUGINS_SETUP_TIMEOUT_SECONDS` | Maximum time for all plugins to complete | `20` |
| `PREFECT_PLUGINS_STRICT` | Exit if a required plugin fails | `0` (disabled) |
| `PREFECT_PLUGINS_SAFE_MODE` | Load plugins without executing hooks | `0` (disabled) |

### Examples

**Allow only specific plugins:**
```bash
export PREFECT_PLUGINS_ALLOW="aws-plugin,gcp-plugin"
```

**Deny problematic plugins:**
```bash
export PREFECT_PLUGINS_DENY="legacy-plugin"
```

**Enable strict mode for production:**
```bash
export PREFECT_PLUGINS_STRICT=1
```

**Debug plugins without execution:**
```bash
export PREFECT_PLUGINS_SAFE_MODE=1
```

## Plugin API

### Hook Specification

Plugins implement the `setup_environment` hook to configure the environment:

```python
from prefect._experimental.plugins import register_hook, HookContext, SetupResult

class MyPlugin:
    @register_hook
    def setup_environment(self, *, ctx: HookContext) -> SetupResult | None:
        """
        Prepare process environment for Prefect.

        Args:
            ctx: Context with Prefect version, API URL, and logger factory

        Returns:
            SetupResult with environment variables, or None for no changes
        """
        logger = ctx.logger_factory("my-plugin")
        logger.info(f"Running with Prefect {ctx.prefect_version}")

        # Return None if no setup needed
        if not should_configure():
            return None

        # Return SetupResult with configuration
        return SetupResult(
            env={"KEY": "value"},
            note="Short description",
            expires_at=datetime,  # Optional
            required=False  # Optional
        )
```

<Note>
The `@register_hook` decorator is **required** to mark your method as a plugin hook implementation. Without it, your plugin methods will not be discovered by the plugin system.
</Note>

### HookContext

The context object passed to plugins:

```python
@dataclass
class HookContext:
    prefect_version: str  # e.g., "3.0.0"
    api_url: str | None   # Configured Prefect API URL
    logger_factory: Callable[[str], logging.Logger]  # Create loggers
```

### SetupResult

The result returned by plugins:

```python
@dataclass
class SetupResult:
    env: Mapping[str, str]           # Environment variables to set
    note: str | None = None           # Human-readable description
    expires_at: datetime | None = None  # When credentials expire
    required: bool = False            # Abort in strict mode if fails
```

## Real-World Example: AWS Credentials Plugin

Here's a complete example of a plugin that assumes an AWS IAM role and provides temporary credentials:

```python
# prefect_aws_setup/__init__.py
from __future__ import annotations

import os
from datetime import timezone

import botocore.session
from prefect._experimental.plugins import register_hook, HookContext, SetupResult

PREFECT_PLUGIN_API_REQUIRES = ">=0.1,<1"


class Plugin:
    @register_hook
    def setup_environment(self, *, ctx: HookContext) -> SetupResult | None:
        """Assume AWS IAM role and provide temporary credentials."""
        logger = ctx.logger_factory("prefect-aws-setup")

        role_arn = os.getenv("PREFECT_AWS_SETUP_ROLE_ARN")
        if not role_arn:
            logger.debug("PREFECT_AWS_SETUP_ROLE_ARN not set, skipping")
            return None

        profile = os.getenv("PREFECT_AWS_SETUP_PROFILE")
        region = os.getenv("AWS_REGION", "us-east-1")
        duration = int(os.getenv("PREFECT_AWS_SETUP_DURATION", "3600"))

        try:
            # Create AWS session and assume role
            session = botocore.session.Session(profile=profile)
            sts = session.create_client("sts", region_name=region)

            response = sts.assume_role(
                RoleArn=role_arn,
                RoleSessionName="prefect-plugin",
                DurationSeconds=duration
            )

            credentials = response["Credentials"]

            return SetupResult(
                env={
                    "AWS_ACCESS_KEY_ID": credentials["AccessKeyId"],
                    "AWS_SECRET_ACCESS_KEY": credentials["SecretAccessKey"],
                    "AWS_SESSION_TOKEN": credentials["SessionToken"],
                    "AWS_REGION": region,
                },
                note=f"Assumed role {role_arn.split('/')[-1]}",
                expires_at=credentials["Expiration"].astimezone(timezone.utc),
                required=bool(os.getenv("PREFECT_AWS_SETUP_REQUIRED")),
            )
        except Exception as e:
            logger.exception("Failed to assume AWS role")
            if os.getenv("PREFECT_AWS_SETUP_REQUIRED"):
                raise
            return None
```

**Package configuration:**

```toml
# pyproject.toml
[project]
name = "prefect-aws-setup"
version = "0.1.0"
dependencies = ["prefect>=3.4", "botocore>=1.34"]

[project.entry-points."prefect.plugins"]
aws_setup = "prefect_aws_setup:Plugin"
```

**Usage:**

```bash
# Configure the plugin
export PREFECT_AWS_SETUP_ROLE_ARN="arn:aws:iam::123456789012:role/PrefectRole"
export PREFECT_AWS_SETUP_PROFILE="my-aws-profile"
export AWS_REGION="us-west-2"
export PREFECT_AWS_SETUP_REQUIRED=1

# Enable plugins
export PREFECT_EXPERIMENTAL_PLUGINS=1

# Run Prefect commands - credentials are automatically configured
prefect deploy --all
```

## Diagnostics

Use the diagnostic command to troubleshoot plugin issues:

```bash
prefect experimental plugins diagnose
```

**Example output:**

```
Prefect Experimental Plugin System Diagnostics

Enabled: True
Timeout: 20.0s
Strict mode: False
Safe mode: False
Allow list: None
Deny list: None

Discoverable Plugins (entry point group: prefect.plugins)

  • aws-setup: active
    Module: prefect_aws_setup:Plugin
    API requirement: >=0.1,<1

Running Startup Hooks

  • aws-setup: success
    Environment variables: 4
      AWS_ACCESS_KEY_ID=••••••
      AWS_SECRET_ACCESS_KEY=••••••
      AWS_SESSION_TOKEN=••••••
      AWS_REGION=us-west-2
    Note: Assumed role PrefectRole
    Expires: 2024-01-15 18:30:00+00:00
```

## Security Considerations

<Warning>
**Security Best Practices**

- Only install plugins from trusted sources
- Review plugin source code before installation
- Use `PREFECT_PLUGINS_DENY` to quarantine known-bad plugins
- Sensitive values are automatically redacted in logs and diagnostics
- Plugins run with the same permissions as Prefect
</Warning>

### Secret Redaction

The plugin system automatically redacts sensitive environment variables in logs and diagnostics. Variables containing these keywords are redacted:

- `SECRET`
- `TOKEN`
- `PASSWORD`
- `KEY`

Example:
```python
# This environment variable will be redacted
{"AWS_SECRET_ACCESS_KEY": "••••••"}

# This will not
{"AWS_REGION": "us-east-1"}
```

### Permissions

Plugins execute with the same permissions as the Prefect process. Be cautious about:

- Environment variables can affect all child processes
- File system access matches the Prefect process user
- Network calls are unrestricted
- Plugins can import any installed package

## Behavior & Guarantees

### Import-Time Execution

Plugins run **automatically when Prefect is imported**, before any other Prefect code executes. This means:
- Environment variables are available to all Prefect operations
- Credentials are configured before connecting to APIs
- Setup happens once per process, not per CLI command

If plugin initialization fails (and strict mode is disabled), Prefect will log the error and continue loading.

### Execution Order

- Plugins are discovered via entry points in the `prefect.plugins` group
- Execution order is not guaranteed
- Multiple plugins may modify the same environment variables (last write wins)

### Error Handling

- Plugin errors are isolated and logged
- One plugin's failure doesn't affect others
- In strict mode with `required=True`, plugin failures abort startup
- Timeouts apply globally to all plugins combined

### Async Support

Plugins can be either synchronous or asynchronous:

```python
from prefect._experimental.plugins import register_hook

class SyncPlugin:
    @register_hook
    def setup_environment(self, *, ctx: HookContext):
        # Synchronous implementation
        return SetupResult(env={"KEY": "value"})

class AsyncPlugin:
    @register_hook
    async def setup_environment(self, *, ctx: HookContext):
        # Asynchronous implementation
        await fetch_data()
        return SetupResult(env={"KEY": "value"})
```

### Idempotence

Plugins should be idempotent - multiple invocations should produce the same result. Prefect may call plugins multiple times during initialization or in different processes.

## Version Compatibility

Specify API version requirements in your plugin:

```python
# Require plugin API version 0.1.x
PREFECT_PLUGIN_API_REQUIRES = ">=0.1,<1"
```

The current plugin API version is `0.1`. This will be incremented when breaking changes are made.

## Troubleshooting

### Plugin Not Running

1. Verify plugins are enabled:
   ```bash
   echo $PREFECT_EXPERIMENTAL_PLUGINS
   ```

2. Check plugin is discoverable:
   ```bash
   prefect experimental plugins diagnose
   ```

3. Verify entry point is registered:
   ```bash
   pip show your-plugin-package
   ```

### Plugin Errors

1. Enable safe mode to test loading without execution:
   ```bash
   PREFECT_PLUGINS_SAFE_MODE=1 prefect experimental plugins diagnose
   ```

2. Check plugin logs:
   ```bash
   PREFECT_LOGGING_LEVEL=DEBUG prefect --version
   ```

3. Test plugin in isolation:
   ```bash
   PREFECT_PLUGINS_ALLOW="your-plugin" prefect experimental plugins diagnose
   ```

### Timeout Issues

Increase the timeout for slow operations:
```bash
export PREFECT_PLUGINS_SETUP_TIMEOUT_SECONDS=60
```

Or optimize plugin startup time by deferring expensive operations.

## Migration & Future Changes

<Info>
The plugin system is experimental and APIs may change. Future improvements may include:

- Additional hook types (`refresh_environment`, `register_blocks`, etc.)
- Per-plugin timeouts and priorities
- Persistent caching of plugin results
- Enhanced error types and diagnostics
- Migration path to stable API
</Info>

When the plugin system stabilizes, plugins will be able to migrate from `_experimental` to a stable API with a clear deprecation path.

## FAQ

**Q: When should I use plugins vs. environment variables?**

A: Use plugins when you need dynamic, short-lived credentials or complex setup logic. Use environment variables for static configuration.

**Q: Can plugins access the Prefect client?**

A: Not in the current version. Plugins run before Prefect is fully initialized. Future versions may provide client access.

**Q: How do I share data between plugins?**

A: Use environment variables. Plugins can read variables set by earlier plugins.

**Q: Are plugins loaded in workers and agents?**

A: Yes, when the feature flag is enabled. The same hooks run in CLI, workers, and agents.

**Q: Can I use plugins without the `@register_hook` decorator?**

A: No, the `@register_hook` decorator is required. Plugin methods without this decorator will not be discovered or called by the plugin system.

## Examples Repository

Find more plugin examples in the [Prefect Examples Repository](https://github.com/PrefectHQ/prefect/tree/main/examples).
